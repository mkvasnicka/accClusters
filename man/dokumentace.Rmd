---
title: "Dokumentace softwaru pro přípravu dat pro vizualizaci dopravních nehod v\ ČR"
output: 
  pdf_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
    keep_tex: no
    pandoc_args: --highlight-style=dokumentace.theme
header-includes:
   - \usepackage{babel}
   - \usepackage{indentfirst}
   - \usepackage[utf8]{inputenc}
   - \usepackage[T1]{fontenc}
   - \usepackage{charter}
   - \usepackage[charter]{mathdesign}
   - \usepackage[scaled]{berasans}
   - \selectlanguage{czech}
   - \captionsczech
   - \renewcaptionname{czech}{\contentsname}{Obsah}
   - \addtokomafont{section}{\clearpage}
   - \let\OriMakeTitle\maketitle
   - \def\maketitle{\OriMakeTitle\vskip1\baselineskip\includegraphics[width=\linewidth]{title_fig.pdf}\vskip11\baselineskip Software byl vytvořen týmem Masarykovy univerzity s~podporou grantu TAČR CK01000049 {\em Tvorba pokročilých nástrojů pro analýzu dopravních nehod pro Policii ČR}.\thispagestyle{empty}}
   - \pagestyle{empty}
   - \tolerance=4500
   - \emergencystretch=11pt
   - \def\sw{\textsf{\textbf{accClusters}}}
documentclass: scrartcl
classoption: a4paper
fontsize: 11pt
geometry: left=25mm, right=25mm, top=25mm, bottom=40mm
bibliography: references.bib
---

<!--
Návod k nastavení LaTeXové třídy scrartcl je zde:
http://mirrors.ibiblio.org/CTAN/macros/latex/contrib/koma-script/doc/scrguien.pdf

Návod k nastavení barevného zvýraznění kódu:
https://community.rstudio.com/t/edit-tango-highlight/39106/2

Jak nastavit barevné zvýraznění v YAML:
https://stackoverflow.com/questions/24682878/set-highlight-style-from-pandoc-yaml-front-matter

Příklady vestavěného barevného zvýraznění kódu:
https://www.garrickadenbuie.com/blog/pandoc-syntax-highlighting-examples/
-->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = 'png', dpi = 600)
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(knitr)
```



\newpage
\pagestyle{plain}
\setcounter{page}{1}



# Úvod

Tento text popisuje instalaci a použití softwaru \sw.
Software \sw{} je součástí softwaru pro vizualizaci dopravních nehod vytvořeného s\ podporou grantu TAČR CK01000049 *Tvorba pokročilých nástrojů pro analýzu dopravních nehod pro Policii ČR*. V\ rámci tohoto projektu byly vytvořeny dva nástroje:

- offline neinteraktivní software \sw, který ze vstupních dat spočítá potřebné metriky, identifikuje místa častých nebo nebezpečných nehod a připraví podklady potřebné pro jejich interaktivní vizualizaci a
- interaktivní webová aplikace, která data vizualizuje.

(Rozdělení softwaru do dvou částí je nutné kvůli výpočetní náročnosti přípravy dat, kterou není možné provádět za běhu. Nejdříve se tedy pomocí přípravné aplikace všechna data předpočítají, a\ pak se vizualizují ve webové aplikaci.)





# Systémové nároky {#sec:hw-sw-config}

Výpočty jsou poměrně hardwarově náročné. Proto se předpokládá následující minimální konfigurace hardwaru a softwaru:

- procesor minimálně třídy i5 (vyšší je lepší), minimálně 4\ jádra (větší počet jader je výhodou),
- minimálně 32\ GB operační paměti dedikované pro tento software (více jader vyžaduje více operační paměti),
- operační systém Linux nebo Windows a
- docker.

Drtivá většina výpočtů běží paralelně na více jádrech. Čím větší počet jader má systém dedikovaný, tím rychleji příprava dat proběhne. Odhadovaný čas při prvním spuštění softwaru je při procesoru třídy\ i5 se čtyřmi jádry a 32\ GB operační paměti kolem tří dny v\ případě práce s\ nespojitými hustotami pravděpodobnosti. V\ případě práce se spojitými hustotami pravděpodobnosti lze očekávat několikanásobně delší přípravu dat. Zvýšení počtu jader spojené se zvětšením dostupné paměti tento čas proporcionálně zkrátí.

Výpočet běžící na každém jádru vyžaduje typicky cca 4\ GB operační paměti (v\ některých krocích však 10\ GB). Větší počet jader se tedy může použít pouze v\ případě, že je k\ dispozici dostatečné množství dedikované operační paměti.

Jako "dedikovaná operační paměť" se chápe paměť, kterou má software k\ dispozici, tj.\ která není okupovaná operačním systémem ani jinými procesy. V\ případě virtualizace se jedná o\ operační paměť, která je vyhrazena danému kontejneru.





# Instalace a spuštění softwaru

## Instalace softwaru

## Spuštění softwaru

## Přenos výsledků do vizualizačního softwaru





# Jak systém funguje

V\ tomto oddílu popíšeme, jak software \sw{} funguje jako celek. V\ dalších oddílech pak podrobněji vysvětlíme strukturu použitých vstupů, konfiguraci softwaru, interpretaci nehodových klastrů a použití výstupu pro GIS.


## Obecný přehled

Po svém spuštění software \sw{} postupně provádí následující kroky:

1. vytvoří logovací soubor, kam systém loguje probíhající operace a případná varování a chyby,
1. načte konfiguraci systému a vytvoří si její binární reprezentaci,
1. vytvoří tabulku okresů, pro které připravuje data, a\ to jak pro další výpočty, tak (v\ jiném formátu) pro vizualizační software,
1. nachystá mapové podklady o\ silniční síti,
1. připraví podklady o\ jednotlivých nehodách, opět ve verzi pro další výpočty a pro vizualizační software,
1. spočítá hustoty pravděpodobnosti nehod nebo škod způsobených nehodami na celé silniční síti,
1. najde klastry úseků silniční sítě s\ výraznou pravděpodobností nehod nebo způsobených škod a
1. jako bonus převede klastry nebezpečných úseků do formátu pro GIS.

Další krok se vždy začne provádět až po skončení předchozího kroku. Některé kroky (zejména kroky\ 1--3) jsou rychlé a provádí se na jednom jádru. Ostatní kroky se musejí provést zvlášť pro každý okres nebo kombinaci okresu, časového období a různých alternativních nastavení systému. Tyto kroky jsou paralelizované a běží na více jádrech systému\ -- vždy jeden okres nebo kombinace okresu, období a parametrizace výpočtu na jednom jádře. Další krok se spustí vždy až ve chvíli, kdy doběhne výpočet tohoto kroku na všech jádrech.

Návaznost mezi jednotlivými kroky funguje podobně jako závislosti v\ programu `make`: Nová binární reprezentace konfigurace se vytvoří pouze v\ případě, že neexistuje, nebo je starší než zdrojové konfigurační soubory. Nová tabulka okresů se vytvoří pouze v\ případě, že neexistuje nebo je starší než binární konfigurace nebo zdrojový *shapefile* okresů, na kterém závisí. Mapové podklady se přepočítají pouze v\ případě, že neexistují, nebo jsou starší než binární konfigurace, tabulka okresů nebo zdrojový *shapefile* silniční sítě atd.

Tento postup zajišťuje, že se v\ případě aktualizace vstupních dat (viz oddíl\ \ref{kap:input-data}) přepočítají jen ty hodnoty, které je třeba aktualizovat. (To samozřejmě vyžaduje, aby se zachovaly všechny soubory s\ průběžnými výpočty z\ minulého spuštění softwaru.) Současně také platí, že pokud výpočet z\ jakéhokoli důvodu selže nebo je přerušen, začne při příštím spuštění pracovat tam, kde v\ předchozím běhu skončil. 

Při prvním spuštění tedy proběhnou všechny kroky. Po následné aktualizaci dat o\ dopravních nehodách však proběhnou pouze kroky\ 1 a 5--8, takže příprava dat bude rychlejší než při prvním spuštění. Pokud uživatel aktualizuje data o\ tvaru okresů nebo data o\ silniční síti, bude aktualizován jak daný krok, tak všechny následující. Pokud uživatel změní konfigurační soubor nebo profily, budou aktualizována všechna data.

Jistou nevýhodou tohoto procesu je fakt, že všechny finální i\ průběžně vytvářené soubory vždy závisí na binární konfiguraci systému. Pokud se změní, proběhnou všechny výpočty vždy od začátku. Pokud změna konfigurace nezmění validitu některých souborů, je možné jejich přepočítání zabránit tak, že je datum jejich poslední modifikace nastaveno na novější čas, než jaký má soubor nově vytvořené binární konfigurace. Tento postup však výrazně nedoporučujeme.


## Použitá adresářová struktura

Software \sw{} pracuje s\ pevnou adresářovou strukturou, ve které jsou umístěna všechna vstupní data, výstupní data, mezivýpočty, konfigurace a logy. Všechna tato data musí být umístěna v\ příslušných složkách v\ hlavním adresáři (dále označovaném jako `DIRORIGIN`). Tento adresář musí obsahovat následující složky:

- `config` ... složka s\ konfigurací softwaru,
- `rawdata` ... složka se vstupními daty,
- `tmp` ... složka s\ mezivýpočty,
- `output` ... složka, kam budou umístěny výstupní soubory určené k\ následné vizualizaci, a
- `log` ... adresář s\ logy.


## Logování

Při každém spuštění \sw{} se v\ adresáři `DIRORIGIN/log` vytvoří nový logovací soubor se jménem `YYYY-MM-DD-hh-mm-ss.log`, kde `YYYY-MM-DD` je datum a `hh-mm-ss` je čas spuštění systému. Všechny kroky systému a případná varování či chyby se logují do tohoto souboru.


## Konfigurace systému

Konfigurace systému je detailně popsaná v\ oddílu\ \ref{kap:konfigurace}. Zde popíšeme pouze to, jak se ze zdrojových (textových) konfiguračních souborů vytváří binární konfigurace.

Při tvorbě binární konfigurace hledá \sw{} v\ adresáři `DIRORIGIN/config` soubory `config.R` a `profile_???.R`, kde `???` jsou nějaké znaky anglické abecedy nebo číslice. Soubor `config.R` je povinný, soubory `profile_???.R` jsou volitelné.

Pokud je kterýkoli z\ existujících souborů novější než binární konfigurační soubor `profiles.rds`, binární konfigurace se aktualizuje. Tento systém funguje dobře v\ případě, že uživatel aktualizuje konfiguraci ve stávajících souborech nebo přidá nové profily. Pokud pouze smaže některý profilový soubor, k\ aktualizaci binární konfigurace nedojde. V\ takovém případě je třeba po smazání profilu smazat i\ binární konfigurační soubor `profiles.rds`. Pak bude binární konfigurační soubor vytvořen správně.


## Tabulka okresů

Tabulka okresů definuje tvar jednotlivých okresů jako mapový polygon. Tato data je třeba aktualizovat pouze v\ případě, že se změní tvary jednotlivých okresů v\ ČR.

Pozor: Před aktualizací *shapefilu* definujících okresy ČR je třeba zkontrolovat, že nový *shapefile* používá stejná jména proměnných v\ atributové tabulce, že mají stejný význam, že obsahuje všechny potřebné okresy (včetně Hlavního města Prahy jako jednoho polygonu) a že má stejnou projekci. Pokud tomu tak není, bude změna mapového podkladu nutně spojena s\ nutností upravit software \sw.¨


## Data o\ jednotlivých nehodách

Data o\ dopravních nehodách se připravují ve dvou formách: 1)\ pro vizualizační část softwaru a 2)\ pro další výpočty. V\ obou případech jsou spojena data ze všech tabulek, které PČR do systému exportuje (viz\ oddíl\ \ref{sec:accidents}) a následně jsou rozdělena do jednotlivých souborů podle okresů.

V\ případě dat použitých pro identifikaci nehodových úseků jsou okresy zvětšeny o\ určitou vzdálenost (důvod je vysvětlen níže) a ze souboru jsou vyloučeny všechny nehody, které neleží dostatečně blízko u\ silniční sítě (nastavení viz\ oddíl\ \ref{kap:konfigurace}). Geolokace těchto nehod je zřejmě defektní a tyto nehody by do identifikace problémových úseků pouze zanesly šum.


## Mapa silniční sítě

Příprava mapysilniční sítě probíhá v\ několika navazujících krocích:

1. Z\ celé mapy silniční sítě se vyfiltrují pouze podporované typy cest (vyhodí se lesní cesty apod.) a silnice se ořežou na jednotlivé okresy. Okresy jsou přitom zvětšeny o\ určitou vzdálenost na všechny strany (důvod je vysvětlen níže). K\ filtraci a ořezu silniční sítě se používá software `osmium`.
1. Silniční síť se zjednoduší tak, aby byla zachovaná její topologie. V\ použitých OpenStreetMaps se totiž často silnice často skládají z\ velmi krátkých úseků, někdy o\ délce pouhých několika centimetrů. Takto krátké úseky jsou pospojovány do delších celků, pokud takto vzniklá silnice příliš nevybočí z\ tvaru skutečné silnice. V\ některých případech jsou spojeny i\ velmi blízké uzly nepodstatné pro topologii sítě (typicky v\ případě, že je jednoduchá křižovatka reprezentovaná více než jedním uzlem).
1. Silniční síť je rozlámána do krátkých úseků (implicitně o\ délce 5\ metrů); tyto úseky nazýváme *lixely*. Silniční síť byla v\ předchozím kroku zjednodušena právě proto, aby výsledné *lixely* mohly mít stejnou délku a tato délka nebyla extrémně krátká. Všechny následující výpočty probíhají na úrovni *lixelů*. Pro každý *lixel* je stanoven i\ bod v\ jeho středu, který tento *lixel* reprezentuje.
1. Nakonec je zkonstruována datová struktura, která popisje geometrii sítě, tj.\ určuje, které *lixely* spolu sousedí.


## Hustoty pravděpodobnosti škod způsobených nehodami {#sec:nkdeIntro}

Nejdůležitější a výpočetně nejnáročnější část hledání nebezpečných úseků spočívá ve výpočtu síťové jádrové hustoty (NKDE) nehod pro každý *lixel* silniční sítě reprezentovaný jeho středem. NKDE se počítají pomocí balíku **spNetwork** [@GelbRJournal; @GelbManual], který představuje nejlepší dostupnou implementaci algoritmů pro jejich výpočet.

Jádrová hustota představuje jádrové vyhlazení bodového procesu na síti a fakticky odhad prostorového bodového procesu, který na síti generuje nehody. Intuice odhadu NKDE je následující: Nad každou nehodou se na silniční síti nakreslí kopeček (*jádro*; používají se jádra obvyklého typu *quartic*); buď mají všechny nehody kopečky stejně velké, nebo závažnější nehody mají větší kopečky než méně závažné nehody. Na křižovatkách se "výška kopečků" rozděluje buď spojitě, nebo nespojitě. Pak se v\ každém bodě sítě sečte výška všech kopečků, jejichž střed (místo nehody) je od daného bodu maximálně vzdálena o\ vzdálenost\ $b$, což je vyhlazovací konstanta, tzv. *bandwidth*. Čím je vzdálenost $b$ delší, tím více bude odhad NKDE vylazenější. V\ okolí bodu, kde je součet výšky kopečků vysoký, existuje více nehod (nebo jsou závažnější) než v\ okolí bodu, kde je tento součet nižší. Nebezpečné úseky silniční sítě jsou tedy charakterizovány vysokou jádrovou hustotou. (Technický popis odhadu NKDE viz např.\ @GelbRJournal.)

Software \sw{} umí spočítat hustoty pravděpodobnosti mnoha různých typů, viz oddíl\ \ref{sec:pardensities}. V\ nejjednodušším případě spočítá jádrovou hustotu, při které mají všechny nehody stejnou váhu. Ve složitějším mohou mít závažnější nehody vyšší váhu než méně závažné nehody. Systém také umožňuje stanovit délku vyhlazovací konstanty (*bandwidth*)\ $b$ nebo ji nechat adaptivně upravovat tak, že bude kratší v\ regionech s\ vyšší hustotou nehod a delší v\ regionech s\ nižší hustotou nehod, viz\ @GelbManual. Umí také rozdělit "výšku kopečků" na křižovatkách nespojitě nebo spojitě, viz tamtéž.

Odhad NKDE je zkreslen na okrajích sítě ořezané do určitého polygonu, protože se všechny silnice překračující hranice tohoto polygonu (mylně) jeví jako slepé a protože nehody za krajem ořezového polygonu nejsou vzaty v\ úvahu. Z\ tohoto důvodu je při výpočtu NKDE okres zvětšen na všechny strany o\ vzdálenost, která musí být několikrát větší než vyhlazovací konstanta\ $b$. Z\ polygonů okresů jsou také z\ výpočetních důvodů odstraněny "díry" (např.\ v\ okrese Brno venkov a Litoměřice). Tak jsou jsou využity všechny silnice a nehody nejen v\ daném okrese, i\ za jeho hranicí. Hodnoty NKDE uvnitř okresu jsou tedy spočítané správně. Po výpočtu klastrů častých nehod (viz následující oddíl) se pak klastry mimo hranice daného okresu "zahodí".


## Klastry úseků s častými nebo nebezpečnými nehodami

V\ předchozím kroku se pro každý *lixel* silniční sítě spočítala hustota pravděpodobnosti nehody. Tato data jsou následně použita k\ nalezení obzvláště nebezpečných úseků.

Data o\ síťových jádrových hustotách pravděpodobnosti pro jednotlivé *lixely* jsou použita pro identifikaci obzvláště nebezpečných úseků. V\ literatuře neexistuje jasná definice problémového úseku. My proto definujeme obzvláště nebezpečné úseky jako úseky silniční sítě, kde je hustota pravděpodobnosti výskytu nehody nebo škod způsobených nehodami obzvlášť vysoká. Řekněme, že nás zajímá $h$ promile nejnebezpečnějších úseků silniční sítě, které chceme dodatečně rozšířit o\ $a$ dodatečně přidaných lixelů. Hledání klastrů nebezpečných míst pak probíhá v\ následujících krocích:

1. Vybere se $h$ promile *lixelů* s\ nejvyšší hustotou pravděpodobnosti.
1. Idenitifikují se *klastry* takových *lixelů*, tj.\ skupiny takových *lixelů*, které tvoří souvislý graf. Klastr tedy tvoří taková podmnožina *lixelů* vybraných v\ předchozím kroku, že je možné z\ každého *lixelu* v\ daném klastru přejet do jiného *lixelu* v\ tomto klastru čistě přes úseky silniční sítě, které leží v\ tomto klastru.
1. Ke každému klastru se rekurzivně $a\times$ přidají sousední *lixely*, které neleží v\ daném klastru. To znamená, že se pro každý *lixel* v\ klastru najdou jeho sousední *lixely*. Pokud nepatří do klastru, přidají se do něj. Tento postup se opakuje $a$\ krát.
1. Ke klastru se přiřadí ty nehody, které leží na úsecích silnic, které tvoří daný klastr. Pro každý klastr se pak spočítá celková výše škody spočítaná jako součet škod tvořených těmito nehodami.
1. Pokud některé klastry po svém rozšíření v\ předchozím kroku sdílejí některý *lixel* nebo se dotýkají, jsou spojeny.
1. Pro rychlejší vykreslování jsou klastry zjednodušeny tak, že souvislé *lixely* jsou spojeny do jednoho `LINESTRING` a tyto `LINESRTRING` jsou spojeny do `MULTILINESTRING`.

Rozšíření klastrů v\ kroku\ 3 klastry zvětšuje. Pokud je např.\ klastr tvořen čistě lineárním úsekem silniční sítě (např.\ částí jednoho směru dálnice daleko od nájezdů a exitů), znamená zvětšení o\ $4$ *lixely* to že se vybraný segment dálnice prodlouží v\ obou směrech cca o\ 20\ metrů (4\ *lixely* pro cca\ 5\ metrech délky). Pokud je klastr tvořen např.\ několika silnicemi, které se potkávají na křižovatce, je stejným způsobem prodloužena každá ze silnic, které tvoří klastr.

Toto rozšiřování klastrů nehod je důležité proto, že klastr je generován nejen nehodami, kterou jsou ke klastru přiřazeny v\ kroku\ X, ale také nehodami, které leží za "okrajem" klastru. Také tyto nehody totiž do jisté míry přispívají k\ hodnotě NKDE v\ *lixelech*, které klastr tvoří. V\ extrémním případě by se bez rozšíření klastru mohlo stát, že budou existovat krátké klastry nehodových úseků, kterým nebude přiřazena žádná nehoda, a\ nehody, které tento klastr vytvořily budou ležet plně mimo jeho okraje.

Neexistuje jedno jasné kritérium, jak stanovit "správné" hodnoty parametrů $h$ a $a$. Promile nejproblematičtějších úseků silniční sítě, které může chtít analytik vidět, totiž závisí na mnoha faktorech, zejména na objemu zdrojů, které má k\ dispozici na řešení problémů, např.\ na přebudování problémových komunikací nebo umístění policejních hlídek. Software \sw{} proto identifikuje nehodové klastry pro mnoho různých kombinací hodnot\ $h$ a $a$. Uživatel si pak ve webovém vizualizačním nástroji může podle stvých potřeb nastavit, kolik promile nejhorších úseků se mu zobrazí a\ o\ kolik *lixelů* se výsledné klastry zvětší. Více o\ interpretaci klastrů úseků častých nehod viz\ oddíl\ \ref{kap:interpret}.


## Klastry nehodových úseků ve formátu pro GIS

Klastry úseků s\ častými nebo závažnými nehodami jsou exportovány do *shapefilů*, které je možné načíst do GISu. Způsob jejich použití je popsán v\ oddíle\ \ref{kap:gis}.


## Technická dokumentace

Pro případné zájemce jsou detaily fungování softwaru \sw{} dokumentované formou komentářů ve zdrojovém kódu.





# Struktura vstupních dat {#kap:input-data}

V\ této kapitole popíšeme blíže zdroje a strukturu vstupních dat, která software \sw{} vyžaduje. Jedná se o\ tři datové vstupy:

- mapový podklad o\ administrativním členění ČR,
- mapový podklad silniční sítě a
- data o\ jednotlivých dopravních nehodách.


## Administrativní členění ČR

Jako mapový podklad pro administrativní členění se používají data ČÚZK. 
Mapový podklad je k\ dispozici na Geoportálu ČÚZK. Jedná se o\ Soubor správních hranic a hranic katastrálních území ČR.

- zdroj: https://geoportal.cuzk.cz/(S(uufahw3bishqszcklzne0nex))/Default.aspx?mode=TextMeta&side=dSady_hranice10&metadataID=CZ-CUZK-SH-V&mapid=5&head_tab=sekce-02-gp&menu=2521
- přímý odkaz: https://geoportal.cuzk.cz/zakazky/SPH/SPH_SHP_JTSK.zip

Stažený soubor rozzipujte a kompletní obsah adresáře `JTSK` překopírujte do adresáře `DIRORIGIN/rawdata/cuzk`.

**POPIS, JAK DATA TEĎ VYPADAJÍ**

Mapový podklad administrativního členění ČR je nutné aktualizovat po každé změně hranic okresů ČR. Po aktualizace mapy okresů je třeba aktualizovat všechna data novým spuštěním \sw.


## Silniční síť ČR

Jako mapový podklad pro silniční síť se používají data OpenStreetMaps ve formátu jednoho souboru typu `.osm.pbf` sbaleného firmou GEOFABRIC (https://www.geofabrik.de/), který obsahuje nejnovější podobu silniční sítě v\ ČR.

- zdroj: https://download.geofabrik.de/europe/czech-republic.html; první odkaz
- přímý odkaz: https://download.geofabrik.de/europe/czech-republic-latest.osm.pbf

Soubor vložte do adresáře `DIRORIGIN/rawdata/osm`.

Mapu silniční sítě je vhodné jednou za několik let aktualizovat. Po její aktualizaci je třeba aktualizovat všechna data novým spuštěním \sw.


## Data o nehodách {#sec:accidents}

Zdrojem dat o\ nehodách je PČR. Předpokládá se, že data jsou exportována pro každý rok zvlášť tak, že se data pro jeden rok skládají z\ pěti souborů ve formátu\ CSV:

- `####_databaze_nehody.csv`,
- `####_databaze_GPS.csv`,
- `####_databaze_nasledky.csv`,
- `####_databaze_vozidla.csv` a
- `####_databaze_chodci.csv`,

kde `####` představuje daný rok (např.\ 2021).

Formátem CSV se pro naše účely rozumí textový soubor, ve kterém každému záznamu odpovídá jeden řádek. První řádek představuje názvy jednotlivých sloupců psaná malými písmeny. Sloupce jsou odděleny čárkami. Desetinná místa v\ číslech jsou oddělena čárkou. Záznamy, které obsahují čáku, jsou uzavřena do uvozovek.

Jednotlivé soubory musejí obsahovat následující sloupce:

- `####_databaze_nehody.csv`: sloupce `p1`, `p2a`, `p2b`, `p3`, `p4a`, `p4b`, `p4c`, `p5a`, `p5b`, `p6`, `p7`, `p8`, `p9`, `p10`, `p11`, `p12`, `p13a`, `p13b`, `p13c`, `p14`, `p34`, `p35`, `p36`, `p15`,  `p16`, `p17`, `p18`, `p19`, `p20`, `p21`, `p22`, `p23`, `p24`, `p27`, `p28`, `p37`, `p38`, `p39`, `p40`, `p41`, `krok`, `typ`,
- `####_databaze_GPS.csv`: sloupce `p1`, `a`, `b`, `c`, `d`, `e`, `f`, `g`, `h`, `i`, `j`, `k`, `l`, `m`, `n`, `o`, `p`, `q`, `r`, `s`, `t`,
- `####_databaze_nasledky.csv`: sloupce `p1`, `id_vozidla`, `p59a`, `p59b`, `p59c`, `p59d`, `p59e`, `p59f`, `p59g`, `p59h`,
- `####_databaze_vozidla.csv`: sloupce `p1`, `id_vozidla`, `p44`, `p45a`, `p45b`, `p47`, `p48a`, `p48b`, `p49`, `p50a`, `p50b`, `p51`, `p52`, `p53`, `rok`, `pohlavi`, `p55a`, `p55b`, `p56`, `p57`, `p58` a
- `####_databaze_chodci.csv`: sloupce `p1`, `p29`, `p30`, `p31`, `p32`, `p33c`, `p33d`, `p33e`, `p33f`, `p33g`, `p33h`,

kde sloupec `p1` představuje klíčový sloupec, který jednoznačně identifikuje dopravní nehodu.

Data o\ nehodách v\ tomto formátu překopírujte do adresáře `DIRORIGIN/rawdata/accidents`.


## Aktualizace dat

Po aktualizaci vstupních dat nejdříve zkontrolujte, že odpovídají formátu popsanému výše; nejlépe také zkontrolujte, že mají stejnou strukturu jako data používaná dříve.

Potom vymažte obsah adresáře `DIRORIGIN/output` a znovu spusťe software \sw{}, který vytvoří novu verzi výstupních dat.





# Konfigurace systému {#kap:konfigurace}

Chování softwaru \sw, zejména způsob hledání  míst s\ vysokou nehodovostí, je možné relativně flexibilně nastavit pomocí konfiguračních souborů uložených v\ adresáři `DIRORIGIN/config`.

Konfigurace systému je rozdělena do dvou vrstev. Základní konfigurace je obsažena v\ souboru `DIRORIGIN/config/config.R`, který musí být v\ konfiguračním adresáři vždy obsažen a musí obsahovat všechny povinné proměnné. Tento soubor definuje všechny informace, jak se mají data zpracovávat.
Pokud je v\ adresáři `DIRORIGIN/config` uložen pouze tento konfigurační soubor, pak se pro každý okres a zvolený čas najde pouze jeden typ nebezpečných úseků.

Často je ale užitečné najít nebezpečné úseky z\ pohledu více kritérií. Typický příklad je situace, kdy chceme najít 1)\ úseky, kde dochází k\ velkému množství nehod bez ohledu na jejich závažnost, ale současně 2)\ i\ úseky, kde dochází zejména k\ závažným dopravním nehodám. K\ tomu slouží *profily* uložené do souborů `profile_XXX.R`, kde `XXX` je část jména souboru dodaná uživatelem.
Profily umožňují vytvořit několik různých konfigurací systému: např.\ jednu, která při výpočtu nehodových úseků nerozlišuje nehody podle jejich závažnosti, a druhou, která váží závažnost nehod podle zvolených kritérií. Stačí, aby jednotlivé profily definovaly jen ty proměnné, kterými se mezi profily liší; hodnoty ostatních proměnných profil zdědí z\ nastavení `config.R`. (Zároveň však platí, že některé technické parametry mohou být definované pouze v\ `config.R`, a\ jsou tedy všem profilům společné.)

Seznam nezbytných a povolených proměnných se liší pro `config.R` a jednotlivé profily. Seznam těchto proměnných, jejich význam a povolené datové typy jsou stejně jako příklady zadávání jednotlivých typů hodnot uvedeny níže.

Všechny konfigurační soubory jsou technicky R\ skripty, a\ musí tedy dodržet platná syntaktická pravidla jazyka\ R. V\ nejjednodušším případě stačí modifikovat hodnoty proměnných, které skript definuje. Je ovšem také možné používat platné výrazy a dokonce vytvářet vlastní proměnné. Tyto proměnné je však nutné na konci skriptu smazat (mohou tedy sloužit pouze pro zpřehlednění konfigurace).

Ve všech konfiguračních skriptech platí následující pravidla:

- Každý konfigurační skript může obsahovat pouze povolené proměnné; některé proměnné musí obsahovat vždy.
- Tyto proměnné musejí mít přiřazenou platnou hodnotu.
- Vše od znaku křížek (`#`) do konce řádku je komentář a ignoruje se.
- Hodnota se do proměnné přiřazuje pomocí znaku "rovná se" (`=`) tak, že jméno proměnné je vlevo a hodnota vpravo od znaku `=`.
- Hodnoty proměnných mohou být
    - čísla: Čísla se skládají pouze z\ číslic, nesmějí obsahovat mezery a desetinná místa se oddělují desetinnou tečkou (`.`). Velké hodnoty je možné zapsat ve "vědecké notaci", kde např.\ 1\ 000 je možné zapsat jako `1e3`.
    - řetězce: Řetězec je text uzavřený do uvozovek (např.\ `"motorway"`).
    - logické hodnoty: Povolené logické hodnoty jsou `TRUE` pro pravdu/ano a `FALSE` pro nepravdu/ne.
    - vektory čísel nebo řetězců: Vektory se vytváří pomocí funkce `c()`; jednotlivé hodnoty v\ této funkci odděleny čárkami (`,`).
    - tabulky (viz dále)

V\ některých případech mohou být povolené hodnoty dále omezeny; některé parametry mohou např.\ obsahovat pouze kladná celá čísla apod.


## Základní konfigurace (soubor config.R)

V\ tomto oddíle popíšeme všechny proměnné, které musejí být obsaženy v\ základním konfiguračním skriptu `config.R`. Pro přehlednost je rozdělíme do několika kategorií. (Stejným způsobem jsou tyto proměnné rozděleny i\ v\ souboru `config.R`.)


### Časová okna

Nejdříve je třeba nastavit, pro jaká období se mají spočítat klastry míst s\ častými/nebezpečnými nehodami. To je možné udělat dvěma způsoby: buď období generovat automaticky, nebo je zadat ručně. Oba způsoby je možné kombinovat.

V\ případě automatických období uživatel specifikuje jejich délku v\ letech a jejich počet. Řekněme, že délka okna je tři roky, počet oken je dva a nehodové lokality se počítají 31.\ dubna 2023. V\ takovém případě se nehodové lokality spočítají pro roky 2020--2022 (1.\ okno) a 2017--2018 (2.\ okno). Obecně platí, že první časové okno se stanoví tak, aby mělo danou délku v\ letech a končilo 31.\ prosince posledního ukončeného roku. Druhé okno se stanoví tak, aby mělo danou délku a těsně předcházelo 1.\ oknu atd.

Pokud chce uživatel použít automatická okna, musí nastavit tři proměnné:

- `TIME_WINDOW_AUTO` ... logická hodnota, při využití automatických oken `TRUE`,
- `TIME_WINDOW_LENGHT` ... číselný vektor, délka časového okna v\ letech a
- `TIME_WINDOW_NUMBER` ... číselný vektor, počet časových oken, musí mít délku\ 1 nebo stejnou jako `TIME_WINDOW_LENGHT`.

Ukažme si několik příkladů:

Pokud chce uživatel nastavit automatická okna způsobem popsaným výše (délka 3\ roky, počet oken\ 2), stačí v\ konfiguraci nastavit:

```{r, eval=FALSE}
TIME_WINDOW_AUTO = TRUE
TIME_WINDOW_LENGHT = 3
TIME_WINDOW_NUMBER = 2
```

Pokud chce uživatel spočítat nehodové úseky na datech o\ délce 1\ rok a současně jiné úseky na datech o\ délce 3\ roky, může nastavit:

```{r, eval=FALSE}
TIME_WINDOW_AUTO = TRUE
TIME_WINDOW_LENGHT = c(1, 3)
TIME_WINDOW_NUMBER = 2
```

Pokud by navíc chtěl spočítat dvě časová okna délky 3\ roky a tři časová okna délky 1\ rok, nastaví:

```{r, eval=FALSE}
TIME_WINDOW_AUTO = TRUE
TIME_WINDOW_LENGHT = c(1, 3)
TIME_WINDOW_NUMBER = c(3, 2)
```

Ve většině situací bude uživateli stačit používat automatická časová okna, která umožní aktualizovat data bez toho, aby bylo potřeba měnit konfiguraci systému a přepočítávat údaje, které se v\ čase nemění.

V\ některých případech však může uživatel potřebovat najít nehodové lokality v\ pevně zadaných letech. K\ tomu slouží pevná časová okna zadaná pomocí parametru `TIME_WINDOW`. Do tohoto parametru je třeba uložit tabulku se dvěma sloupci, `from_date` (počáteční datum časového okna) a `to_date` (koncové datum okna). Řádky tabulky pak odpovídají jednotlivým časovým oknům. Datum se zadává jako řetězec ve formátu `"YYYY-MM-DD"`.

Dvě pevná časová okna o\ délce tří let je pak možné nastavit např.\ takto:

```{r, eval=FALSE}
TIME_WINDOW = tibble::tribble(
    ~from_date,    ~to_date,
    "2019-01-01",  "2021-12-31",
    "2018-01-01",  "2020-12-31"
)
```

Automatická a pevná časová okna je možné libovolně kombinovat. V\ případě, že budou použita pouze pevná časová okna, je třeba nastavit parametr `TIME_WINDOW_AUTO` na hodnotu `FALSE`.

Stanovení časových období se týká pouze hledání klastrů lokalit s\ častými/nebezpečnými nehodami. Přitom je potřeba pamatovat na dvě věci:

1. Identifikace nehodových klastrů vychází z\ výpočtu síťové hustoty pravděpodobnosti. Její rozumná identifikace vyžaduje dostatečný počet nehod. Minimální rozumná délka použitého období je tedy zhruba 3\ roky.
1. Uživatel musí zajistit, aby měl systém přístup k\ datům o\ nehodách za všechny roky, pro které se nehodové lokality hledají.


### Váhy nehod
Jednotlivé nehody se liší svou závažností. Při hledání klastrů nebezpečných míst je proto užitečné vážit jednotlivé nehody podle jejich závažnosti. Hodnota nehody je rovna 

$$\textrm{cost} = d \times D + s \times S + l \times L + m \times M + c,$$

kde $D$\ je počet lidí, kteří při nehodě zahynuli, $S$\ je počet vážně zraněných, $L$\ je počet lehce zraněných a $M$\ je hodnota materiální škody v\ milionech\ Kč. Uživatel může zadat konstanty $d$, $s$, $l$, $m$ a $c$, které $d$, $s$ a $l$ určují, jaká váha se přikládá smrtelnému, těžkému a lehkému zranění respektive a jaká materiálním škodám. 

Tyto koeficienty je možné nastavit pomocí proměnných 

- `UNIT_COST_DEAD` ... nezáporné číslo, váha smrtelného zranění ($d$),
- `UNIT_COST_SERIOUS_INJURY` ... nezáporné číslo, váha těžkého zranění ($s$),
- `UNIT_COST_LIGHT_INJURY` ... nezáporné číslo, váha lehkého zranění ($l$),
- `UNIT_COST_MATERIAL` ... nezáporné číslo, váha materiální škody v\ milionech\ Kč ($m$) a
- `UNIT_COST_CONST` ... nezáporné číslo, konstanta připočítaná k\ hodnotě každé nehody ($c$).

Příklad nastavení, kde se hodnota smrtelného zranění nastaví na hodnotu 16\ milionů\ Kč, hodnota těžkého zranění na 4\ miliony\ Kč, hodnota lehkého zranění na 1\ milion\ Kč a materiální škoda se zahrne ve své skutečné výši:

```{r, eval=FALSE}
UNIT_COST_DEAD = 16
UNIT_COST_SERIOUS_INJURY = UNIT_COST_DEAD / 4
UNIT_COST_LIGHT_INJURY = UNIT_COST_DEAD / 16
UNIT_COST_MATERIAL = 1
UNIT_COST_CONST = 0

```

Hodnota nehod se při výpočtu rizikových oblastí používá pouze v\ případě, kdy je proměnná `NKDE_WEIGHTS` nastavena na hodnotu `"cost"`, viz dále. Je však dobré nastavit tyto parametry vždy. I\ když chceme najít nehodové klastry, které váží všechny nehody stejně, nastavení těchto parametrů pak umožní říct, které klastry jsou spojeny s\ větší škodou.

Jedno možné nastavení je nastavit parametr\ $d$ na hodnotu statistického života v\ milionech\ Kč, $s$ a $l$ na její poměrné zlomky a $m=1$ a $c=0$.
Odhady hodnoty statistického života pro Českou republiku je možné najít např.\ v\ článcích @AlberiniVSL2011 nebo @ScasnyVSL2012.

Výhodou nastavení parametru\ $d$ na hodnotu statistického života je jasná ekonomická interpretace. Případnou nevýhodou může být fakt, že hodnota statistického života je tak vysoká, že se při jejím použití budou brát v\ úvahu fakticky jen nehody, kde došlo ke smrtelnému (a\ případně i\ těžkému) zranění. Přitom je zřejmé, že to, jestli někdo při nehodě zahynul, je z\ velké části náhodné. Problém je samozřejmě tím větší, pro čím kratší období se hledají klastry nehodových lokalit. Zejména v\ případě kratších časových období proto může být rozumné nastavit parametry `UNIT_COST_DEAD`, `UNIT_COST_SERIOUS_INJURY` a `UNIT_COST_LIGHT_INJURY` na nižší hodnoty.


### Parametry výpočtu hustot {#sec:pardensities}
Další skupina parametrů určuje, jak se počítají hustoty pravděpodobností nehod, ze kterých se pak hledají problémová místa. Patří sem následující parametry (pro jejich detailní významy prosím konzultujte @GelbManual):

- `NKDE_WEIGHTS` ... buď `"cost"` nebo `"equal"`; určuje, jaké váhy se přikládají jednotlivým nehodám: zda váhy určené parametry popsanými v\ předchozím oddílu (hodnota `"cost"`) nebo zda mají všechny nehody stejnou váhu (hodnota `"equal"`)
- `NKDE_METHOD` ... buď `"continuous"` nebo `"discontinuous"`; určuje, jak se počítají hustoty pravděpodobnosti na křižovatkách: buď spojitě (`"continuous"`) nebo nespojitě (`"discontinuous"`); spojitý výpočet je poněkud přesnější, ale je také podstatně pomalejší
- `NKDE_ADAPTIVE` ... logická hodnota; určuje, zda je použito adaptivní vyhlazovací parametr vzdálenosti $b$ (*bandwidth*) popsaný v\ oddíle\ \ref{sec:nkdeIntro} (`TRUE`), nebo zda se vždy použije fixní hodnota\ $b$ vzatá z\ parametru `NKDE_BW` (`FALSE`); při použijí adaptivního vyhlazovacího okna může být výpočet poněkud přesnější, ale je také podstatně pomalejší
- `NKDE_BW` ... kladné číslo; určuje délku vyhlazovacího parametru\ $b$ v\ metrech při použití neadaptivního vyhlazovacího okna (při `NKDE_ADAPTIVE = FALSE`)
- `NKDE_TRIM_BW` ... kladné číslo; určuje maximální délku vyhlazovacího parametru\ $b$ v\ metrech při použití adaptivního okna (když je `NKDE_ADAPTIVE = TRUE`)
- `NKDE_AGG` ... kladné číslo; určuje vzdálenost v\ metrech, ve které se nehody agregují; nehody, které jsou vzájemně blíže než je tato hodnota jsou při výpočtu sloučeny do jedné pro zrychlení výpočtu (váha takto vzniklé umělé nehody je součtem vah sloučených nehod)

Příklad nastavení, při kterém se při výpočtu hustot pravděpodobností bere v\ úvahu závažnost nehod (`NKDE_WEIGHTS = "cost"`) a používá se nespojitá NKDE metoda s\ neadaptivním vyhlazovacím oknem o\ délce 300\ metrů:

```{r, eval=FALSE}
NKDE_WEIGHTS = "cost"
NKDE_METHOD = "discontinuous"
NKDE_BW = 300
NKDE_ADAPTIVE = FALSE
NKDE_TRIM_BW = 600
NKDE_AGG = 1
```

V\ tomto případě se parametr `NKDE_TRIM_BW` ignoruje (musí však být přítomen). Agregují se pouze nehody do vzájemné vzdálenosti 1\ metr (po silnici).

Pokud by bylo cílem sestavit klastry nehod tak, že by všechny nehody měly stejnou váhu, stačilo by změnit první parametr na `NKDE_WEIGHTS = "equal"`. Podobně při změně metody na nespojitou by stačilo změnit na druhém řádku `NKDE_METHOD = "continuous"`. Adaptivní vyhlazovací okno by se zapnulo nastavením `NKDE_ADAPTIVE = TRUE`. V\ takovém případě by se vyhlazovací okno našlo automaticky tak, že jeho největší délka by byla 600\ metrů. Parametr `NKDE_BW` by se v\ takovém případě ignoroval (ale musí být přítomen).


### Příprava mapových podkladů a nehod
Hustoty pravděpodobnosti se počítají na zjednodušené silniční síti. Další skupina parametrů určuje, jak se tato síť zpracuje. Pokud k\ tomu nemáte velmi silný důvod, nechte tyto parametry v\ doporučeném (základním nastavení).

U\ vlastních mapových podkladů je třeba nastavit čtyři parametry.
Parametr `SUPPORTED_ROAD_CLASSES` určuje, které typy cest se zařadí do silniční použité sítě. Podkladová mapa OpenStreetMaps totiž obsahuje cesty mnoha typů, z\ nichž mnohé nejsou určeny pro motorová vozidla. Při výpočtu hustot je třeba tyto typy cest ignorovat. Do proměnné `SUPPORTED_ROAD_CLASSES` zadejte výčet všech typů cest (jako vektor řetězců), které se mají použít. Jména typů cest musejí odpovídat kódování OpenStreetMaps. V\ současné době je v\ základním nastavení skriptu `config.R` výčet všech typů cest, které OpenStreetMaps nyní používají, s\ tím, že nevhodné typy jsou odstraněny pomocí komentářů. Seznam podporavných typů je dostupný na adrese https://wiki.openstreetmap.org/wiki/Key:highway.

Všechny výpočty probíhají po jednotlivých okresech. Aby nedocházelo ke zkreslením na hranicích okresu, je po dobu výpočtu třeba zahrnout i\ silnice a nehody, které leží nedaleko za hranicí okresu (na konci výpočtu budou údaje ležící za hranicí okresu opět odříznuty). Proměnná `DISTRICT_BUFFER_SIZE` určuje o\ kolik metrů se má pro potřeby výpočtu posunout hranice okresu. Hodnota této proměnné musí být dostatečně větší než hodnota proměnných `NKDE_BW` (a\ `NKDE_TRIM_BW`, pokud je  hodnota `NKDE_ADAPTIVE` nastavena na `TRUE`).

Pro účely výpočtů hustot pravděpodobností nehody je třeba rozdělit silniční síť do krátkých (*lixelů*). Tyto lixely musejí být tak krátké, aby byly v\ rámci silniční sítě velmi podobně dlouhé; zároveň však platí, že čím jsou kratší, tím je jich více a výpočet běží pomaleji a vyžaduje vyšší zdroje. Typickou délku *lixelů* v\ metrech nastavuje parametr `LIXEL_SIZE`. Parametr `LIXEL_MIN_DIST` určuje minimální délku *lixelu* v\ metrech; kratší lixely budou připojeny k\ někerému sousednímu *lixelu*.

Některé nehody mohou být zaměřeny velmi nepřesně\ -- daleko od silniční sítě. V\ takovém případě se při výpočtu rizikových míst ignorují. Parametr `ACCIDENT_TO_ROAD_MAX_DISTANCE` určuje maximální vzdálenost od silniční sítě v\ metrech, při které jsou nehody použitý při hledání rizikových oblastí.

Doporučené nastavení těchto parametrů je následující:

```{r, eval=FALSE}
DISTRICT_BUFFER_SIZE = 3e3  # okres je zvětšen na všechny strany o 3 kilometry
LIXEL_SIZE = 5  # typická délka lixelu je 5 metrů
LIXEL_MIN_DIST = 2  # minimální délka lixelu je 2 metry
ACCIDENT_TO_ROAD_MAX_DISTANCE = 30  # nehoda nesmí být dál než 30 metrů od silnice
SUPPORTED_ROAD_CLASSES = c("motorway", "motorway_link",
                           "trunk", "trunk_link",
                           "primary", "primary_link",
                           "secondary", "secondary_link",
                           "tertiary", "tertiary_link",
                           "residential", "living_street", "pedestrian",
                           "service", "unclassified", "road",
                           "construction"
)
```

Doporučený výběr silnic (parametr `SUPPORTED_ROAD_CLASSES`) obsahuje i\ silnice v\ opravě (`"construction"`). Důvod je ten, že délka oprav silnic je typicky kratší než délka všech časových oken, pro které by měla být nalezeny nehodové úseky. Silnice také nemusí být zcela uzavřena a někteří řidiči mohou na takovou silnici vjet a havarovat.


### Nastavení paralelních výpočtů
Většina přípravy dat probíhá paralelně na větším počtu jader. Parametry uvedné v\ tomto oddíle určují, kolik jader může být paralelně využito. Jsou zde dvě možnosti: Buď uživatel nastaví počet jader sám, nebo dovolí systému, aby počet jader sám odhadl. 

Doporučené je použití automatického mechanismu. Ten zohlední jednak to, kolik jader je v\ systému k\ dispozici (nebo kolik jich má alokovaný dockerový kontejner), jednak to, kolik je k\ dispozici volné operační paměti (nebo kolik jí má k\ dispozici dockerový kontejner).

V\ tomto případě uživatel nastaví parametry `NO_OF_WORKERS` a `NO_OF_WORKERS_ACCIDENTS` na hodnoty `"auto"` a současně nastaví proměnné `RAM_PER_CORE_GENERAL` a `RAM_PER_CORE_ACCIDENTS` na počet GB paměti RAM, který musí být dostupný na výpočet na jedno jádro. V\ současné době jsou tyto proměnné nastavené na konzervativní úrovni 4.5 a 10\ GB respektive. Při zvětšení objemu zpracovávaných dat však může být nezbytné tyto proměnné zvětšit.

Doporučené nastavení je tedy:

```{r, eval=FALSE}
NO_OF_WORKERS = "auto"
NO_OF_WORKERS_ACCIDENTS = "auto"
RAM_PER_CORE_GENERAL = 4.5
RAM_PER_CORE_ACCIDENTS = 10
```

V\ případě potřeby může uživatel nastavit parametry `NO_OF_WORKERS` a `NO_OF_WORKERS_ACCIDENTS` přímo na počet jader, který se má použít. V\ tom případě je však zodpovědný za to, aby měl systém dost volné operační paměti. Pokud ji mít nebude, systém "spadne".


### Parametry pro hledání klastrů
Mechanismus hledání klastrů je poměrně jednoduchý. Nejdříve se najdou všechny souvislé lixely s\ hustotou pravděpodobnosti vyšší než zadaný práh\ $h$. Tak vzniknou prvotní klastry. Následně se tyto klastry rozšíří na všechny strany o\ $v$\ lixelů. V\ posledním kroku spojí ty klastry, které mají vzájemný průnik.

Práh\ $h$ je stanoven dynamicky jako určitý vysoký kvantil. Tento kvantil je určen proměnnou `CLUSTER_MIN_QUANTILE`, která musí nabývat hodnotu z\ intervalu $[0,1]$, typicky však velmi blízkou jedné. Počet dodatečných lixelů\ $v$ je určen proměnnou `CLUSTER_ADDITIONAL_STEPS` (minimální hodnota je\ 1).

Do interaktivní aplikace jsou exportovány i\ lixely, které mají vysokou hodnotu pravděpodobnosti nehody. Minimální kvantil lixelů, které jsou takto exportovány, určuje proměnná `VISUAL_MIN_QUANTILE`. Tato proměnná musí mít vždy menší hodnotu než `CLUSTER_MIN_QUANTILE`.


## Profily


## Zpracovaná konfigurace a profily

Software pro přípravu dat nejdříve načte konfiguraci a všechny profily, zkontroluje je a uloží do souboru `profiles.rds`. Tento soubor proto vymažte pouze v\ případě, kdy je třeba zajistit kompletní přepočítání konfigurace a profilů, např.\ v\ případě, kdy byl některý profil smazán.


## Aktualizace konfigurace a profilů




# Interpretace klastrů {#kap:interpret}





# Výstup pro GIS {#kap:gis}

Složka `DIRORIGIN/data/output/gis` obsahuje identifikovaná nebezpečná místa exportovaná ve formátu pro GIS. Data jsou rozdělena po jednotlivých okresech tak, že nebezpečné úseky pro každý okres jsou umístěny do zvláštního podadresáře, jehož jméno je NUTS\ 4 kód daného okresu (Hlavní město Praha je chápána jako jeden celek). Kromě těchto adresářů obsahuje složka ještě soubory `profiles.csv` a `profiles.dbf`, které popisují profily, které byly použity při generování nebezpečných míst.

Příklad obsahu adresáře `DIRORIGIN/data/output/gis`:

- `profiles.csv`
- `profiles.dbf`
- `CZ0100`
    - `clusters_CZ0100_cost_2016-01-01_2018-12-31.shp` 
    - `clusters_CZ0100_cost_2019-01-01_2021-12-31.shp`
    - `clusters_CZ0100_cost_2020-01-01_2020-12-31.shp`
    - `clusters_CZ0100_cost_2021-01-01_2021-12-31.shp`
    - `clusters_CZ0100_equal_2016-01-01_2018-12-31.shp`
    - `clusters_CZ0100_equal_2019-01-01_2021-12-31.shp`
    - `clusters_CZ0100_equal_2020-01-01_2020-12-31.shp`
    - `clusters_CZ0100_equal_2021-01-01_2021-12-31.shp`
    - `clustered_accidents_CZ0100_cost_2016-01-01_2018-12-31.dbf`
    - `clustered_accidents_CZ0100_cost_2019-01-01_2021-12-31.dbf`
    - `clustered_accidents_CZ0100_cost_2020-01-01_2020-12-31.dbf`
    - `clustered_accidents_CZ0100_cost_2021-01-01_2021-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2016-01-01_2018-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2019-01-01_2021-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2020-01-01_2020-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2021-01-01_2021-12-31.dbf`
- `CZ...`

(Ke každému souboru typu `.shp` jsou přiloženy i\ odpovídající soubory typů `.dbf`, `.prj` a `.shx`.)



## Shapefily nebezpečných míst

Adresář pro každý okres obsahuje všechny typy nebezpečných míst spočítaných v\ průběhu přípravy dat pro webovou aplikaci. Jednotlivé shapefily mají vždy jméno `clusters_NUTS4_PROFILENAME_YYYY-MM-DD_YYYY-MM-DD`, kde `NUTS4` je kódové jméno okresu, `PROFILENAME` je jméno profilu a `YYYY-MM-DD` označuje den počátku a konce období, pro které byly nebezpečné úseky identifikovány.

Atributová tabulka těchto shapefilů obsahuje následující proměnné:

- `dst_id` ... NUTS\ 4 kód daného okresu,
- `dst_name` ... jméno daného okresu,
- `start` ... datum počátku období, pro které byly nehodové úseky počítány,
- `end` ... datum konce období, pro které byly nehodové úseky počítány,
- `profile` ... jméno profilu, který byl použit,
- `severity` ... kolik promile nejnebezpečnějších úseků tvoří klastr,
- `add_lix` ... o\ kolik *lixelů* byly klastry do všech stran rozšířeny,
- `cluster` ... identifikační číslo daného klastru pro dané hodnoty `dst_id`, `dst_name`, `start`, `end`, `profile`, `severity` a `add_lix`,
- `length` ... délka identifikovaného klastru v\ metrech,
- `density` ... součet hustoty idenfikovaného klastru a
- `cost` ... celkové náklady všech nehod v\ klastru v\ milionech Kč.

Každý shapefile obsahuje nehodové úseky spočítané pro daný okres, profil a časové okno a mnoho různých nastavení hodnot `severity` a `add_lixel`. To má několik důsledků:

1. Při analytické práci je třeba v\ GISu vyfiltrovat zvolené hodnoty `severity` a `add_lixel`.
2. Identifikace klastru pomocí jeho čísla `cluster` není jednoznačná. Úplný klíč k\ identifikaci klastru tvoří kombinace sloupců `dst_id`, `start`, `end`, `profile`, `severity`, `add_lix` a `cluster`.
    - Stejné číslo klastru může existovat pro různé kombinace hodnot `dst_id`, `dst_name`, `start`, `end`, `profile`, `severity` a `add_lix`.
    - Mezi těmito klastry neexistuje žádný vztah.

Návod, jak interpretovat jednotlivé nehodové klastry, viz oddíl\ \ref{sec:interpret}.



## Údaje o\ nehodách na klastrech

Ke každému shapefilu se jménem `clusters_NUTS4_PROFILENAME_YYYY-MM-DD_YYYY-MM-DD` existuje tabulka `clustered_accidents_NUTS4_PROFILENAME_YYYY-MM-DD_YYYY-MM-DD`, která uvádí informace o\ nehodách, které "tvoří" daný klastr. Z\ těchto nehod je spočítaná i\ celková nebezpečnost klastru `cost`.

Atributová tabulka zde obsahuje jen nejnutnější údaje:

- `dst_id` ... NUTS4 kód daného okresu,
- `dst_name` ... jméno daného okresu,
- `start` ... datum počátku období, pro které byly nehodové úseky počítány,
- `end` ... datum konce období, pro které byly nehodové úseky počítány,
- `profile` ... jméno profilu, který byl použit,
- `severity` ... kolik promile nejnebezpečnějších úseků tvoří klastr (hodnota\ 5 znamená, že se klastry skládají z\ 5\ promile nejhorších úseků),
- `add_lix` ... o\ kolik *lixelů* se klastry zvětší,
- `acc_id` ...
- `cluster` ... identifikační číslo daného klastru a
- `cost` ... celkové náklady všech nehod v\ klastru v\ milionech Kč.

Sloupce `dst_id`, `start`, `end`, `profile`, `severity`,  `add_lix` a `cluster` tvoří klíč ke spárování nehody s\ klastry v\ shapefilech. Sloupec `acc_id` tvoří klíč pro spárování nehody v\ policejní databázi. Proměnná `cost` obsahuje cenu nehody v\ milionech Kč spočítanou podle daného profilu.

Předpokládá se, že při potřebě analyzovat jednotlivé nehody, budou tyto nehody načteny z\ policejní databáze a spárovány pomocí klíče `acc_id`.



## Informace o\ nastavení profilů

Informace o\ nastavení použitých profilů jsou uloženy v\ adresáři `DIRORIGIN/data/output/gis` v\ souborech `profiles.dbf` a `profiles.csv`. Oba soubory mají shodnou strukturu. Jedná se o\ tabulku, jejíž jednotlivé řádky odpovídají jednotlivým profilům a použitým časovým oknům. Každý profil je identifikován třemi sloupci:

- `PROFILE_NAME` ... jméno profilu,
- `FROM_DATE` ... počáteční datum období, pro které byly nebezpečné úseky identifikovány, a
- `TO_DATE` ... koncové datum období, pro které byly nebezpečné úseky identifikovány.

Ostatní sloupce  odpovídají jednotlivým parametrům zadaným v\ konfiguračních profilech. 

To znamená, že např.\ shapefilu `clusters_CZ0100_equal_2019-01-01_2021-12-31` odpovídá profil, který má ve sloupci `PROFILE_NAME` hodnotu "equal" a ve sloupcích `FROM_DATE` a `TO_DATE` hodnoty "2019-01-01" a "2021-12-31" respektive.

Tam, kde může daný parametr obsahovat vektor, jsou jednotlivé hodnoty tohoto vektoru převedeny na řetězec a spojeny do jednoho řetězce; jsou odděleny znaky "\  |\ " (mezera, trubka a mezera).

Soubory `profiles.csv` a `profiles.dbf` mají shodný obsah, liší se pouze formátem. Doporučujeme použít soubor ve formátu CSV, protože ve druhém souboru jsou jména sloupců strojově zkrácena. Výhodou souboru ve formátu DBF je to, že je možné jej přímo načíst do GISu.





# Použité zdroje
