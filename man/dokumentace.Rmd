---
title: "Dokumentace softwaru pro přípravu dat pro vizualizaci dopravních nehod v\ ČR"
output: 
  pdf_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
    keep_tex: no
    pandoc_args: --highlight-style=dokumentace.theme
header-includes:
   - \usepackage{babel}
   - \usepackage{indentfirst}
   - \usepackage[utf8]{inputenc}
   - \usepackage[T1]{fontenc}
   - \usepackage{charter}
   - \usepackage[charter]{mathdesign}
   - \usepackage[scaled]{berasans}
   - \selectlanguage{czech}
   - \captionsczech
   - \renewcaptionname{czech}{\contentsname}{Obsah}
   - \addtokomafont{section}{\clearpage}
   - \let\OriMakeTitle\maketitle
   - \def\maketitle{\OriMakeTitle\vskip1\baselineskip\includegraphics[width=\linewidth]{title_fig.pdf}\vskip11\baselineskip Software byl vytvořen týmem Masarykovy univerzity s~podporou grantu TAČR CK01000049 {\em Tvorba pokročilých nástrojů pro analýzu dopravních nehod pro Policii ČR}.\thispagestyle{empty}}
   - \pagestyle{empty}
   - \tolerance=4500
   - \emergencystretch=11pt
documentclass: scrartcl
classoption: a4paper
fontsize: 11pt
geometry: left=25mm, right=25mm, top=25mm, bottom=40mm
---

<!--
Návod k nastavení LaTeXové třídy scrartcl je zde:
http://mirrors.ibiblio.org/CTAN/macros/latex/contrib/koma-script/doc/scrguien.pdf

Návod k nastavení barevného zvýraznění kódu:
https://community.rstudio.com/t/edit-tango-highlight/39106/2

Jak nastavit barevné zvýraznění v YAML:
https://stackoverflow.com/questions/24682878/set-highlight-style-from-pandoc-yaml-front-matter

Příklady vestavěného barevného zvýraznění kódu:
https://www.garrickadenbuie.com/blog/pandoc-syntax-highlighting-examples/
-->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = 'png', dpi = 600)
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(knitr)
```



\newpage
\pagestyle{plain}
\setcounter{page}{1}



# Úvod

Tento text popisuje instalaci a použití softwaru pro přípravu dat pro vizualizaci dopravních nehod v\ ČR.

Software pro vizualizaci dopravních nehod vytvořený s\ podporou grantu TAČR CK01000049 *Tvorba pokročilých nástrojů pro analýzu dopravních nehod pro Policii ČR* má dvě části:

- offline neinteraktivní software, který ze vstupních dat spočítá potřebné metriky, identifikuje místa častých nebo nebezpečných nehod a přípraví podklady potřebné pro jejich interaktivní vizualizaci a
- interaktivní webovou aplikaci, která data vizualizuje.

Tento dokument popisuje použití první části softwaru, která připravuje data; použití webové aplikace je popsané v\ separátním dokumentu.

Rozdělení softwaru do dvou částí je nutné kvůli výpočetní náročnosti přípravy dat, kterou není možné provádět za běhu. Nejdříve se tedy pomocí přípravné aplikace všechna data předpočítají, a\ pak se vizualizují ve webové aplikaci.





# Systémové nároky {#sec:hw-sw-config}

Výpočty jsou poměrně hardwarově náročné. Proto se předpokládá následující minimální konfigurace hardwaru a softwaru:

- procesor minimálně třídy i5 (vyšší je lepší), minimálně 4\ jádra (větší počet jader je výhodou),
- minimálně 32\ GB operační paměti dedikované pro tento software (více jader vyžaduje více operační paměti),
- operační systém **TODO**,
- docker **TODO**,
- **TODO**

Drtivá většina výpočtů běží paralelně na více jádrech. Čím větší počet jader má systém dedikovaný, tím rychleji příprava dat proběhne. Odhadovaný čas při prvním spuštění softwaru je při procesoru třídy\ i5 se čtyřmi jádry a 32\ GB operační paměti kolem tří dny v\ případě práce s\ nespojitými hustotami pravděpodobnosti. V\ případě práce se spojitými hustotami pravděpodobnosti lze očekávat několikanásobně delší přípravu dat. Zvýšení počtu jader spojené se zvětšením dostupné paměti tento čas proporcionálně zkrátí.

Výpočet běžící na každém jádru vyžaduje typicky cca 4\ GB operační paměti (v\ některých krocích však 10\ GB). Větší počet jader se tedy použije pouze v\ případě, že je k\ dispozici dostatečné množství dedikované operační paměti.

Jako "dedikovaná operační paměť" se chápe paměť, která je softwaru k\ dispozici, tj.\ není okupovaná operačním systémem ani jinými procesy. V\ případě virtualizace se jedná o\ operační paměť, která je vyhrazena danému kontejneru.





# Instalace softwaru


konfigurace




# Struktura vstupních dat {#kap:input-data}

Software pracuje s\ pevnou adresářovou strukturou, kterou jsou umístěna všechna vstupní data, výstupní data, mezivýpočty, konfigurace a logy. Všechna tato data musí být umístěna v\ příslušných složkách v\ jednom adresáři (dále označovaném jako `DIRORIGIN`). Tento adresář musí obsahovat následující složky:

- `config` ... složka s\ konfigurací softwaru,
- `rawdata` ... složka se vstupními daty,
- `tmp` ... složka s\ mezivýpočty,
- `output` ... složka, kam budou umístěny výstupní soubory určené k\ následné vizualizaci, a
- `log` ... adresář s\ logy.

V\ této kapitole popíšeme blíže zdroje a strukturu vstupních dat. Software vyžaduje tři datové vstupy:

- mapový podklad o\ administrativním členění ČR\ -- používají se data ČÚZK,
- mapový podklad silniční sítě\ -- používá se OpenStreetMap a
- data k\ jednotlivým dopravním nehodám ve formátu CSV.


## Administrativní členění ČR

Jako mapový podklad pro administrativní členění se používají data ČÚZK. 
Mapový podklad je k\ dispozici na Geoportálu ČÚZK. Jedná se o\ Soubor správních hranic a hranic katastrálních území ČR.

- zdroj: https://geoportal.cuzk.cz/(S(uufahw3bishqszcklzne0nex))/Default.aspx?mode=TextMeta&side=dSady_hranice10&metadataID=CZ-CUZK-SH-V&mapid=5&head_tab=sekce-02-gp&menu=2521
- přímý odkaz: https://geoportal.cuzk.cz/zakazky/SPH/SPH_SHP_JTSK.zip

Stažený soubor rozzipujte a kompletní obsah adresáře `JTSK` překopírujte do adresáře `DIRORIGIN/rawdata/cuzk`.

Mapový podklad administrativního členění ČR je nutné aktualizovat vždy, když se změní hranice okresů ČR. Po aktualizace mapy okresů je třeba aktualizovat všechna data, viz oddíl\ \ref{sec:aktutalizace-dat}.


## Silniční síť ČR

Jako mapový podklad pro silniční síť se používají data OpenStreetMaps ve formátu jednoho souboru typu `.osm.pbf` sbaleného firmou GEOFABRIC (https://www.geofabrik.de/), který obsahuje nejnovější podobu silniční sítě v\ ČR.

- zdroj: https://download.geofabrik.de/europe/czech-republic.html; první odkaz
- přímý odkaz: https://download.geofabrik.de/europe/czech-republic-latest.osm.pbf

Soubor vložte do adresáře `DIRORIGIN/rawdata/osm`.

Mapu silniční sítě je v\ systému třeba jednou za několik let akutalizovat. Po aktualizace mapy silniční sítě je třeba aktualizovat všechna data, viz oddíl\  \ref{sec:aktutalizace-dat}.


## Data o nehodách

Zdrojem dat o\ nehodách je PČR. Předpokládá se, že data jsou exportována pro každý rok zvlášť. Data pro jeden rok se skládají z\ pěti souborů typu CSV:

- `####_databaze_nehody.csv`,
- `####_databaze_GPS.csv`,
- `####_databaze_nasledky.csv`,
- `####_databaze_vozidla.csv` a
- `####_databaze_chodci.csv`,

kde `####` představuje daný rok (např.\ 2021).

Formátem CSV se pro naše účely rozumí textový soubor, ve kterém každému záznamu odpovídá jeden řádek. První řádek představuje názvy jednotlivých sloupců psaná malými písmeny. Sloupce jsou odděleny čárkami. Desetinná místa v\ číslech jsou oddělena čárkou. Záznamy, které obsahují čáku, jsou uzavřena do uvozovek.

Jednotlivé soubory musejí obsahovat následující sloupce:

- `####_databaze_nehody.csv`: sloupce `p1`, `p2a`, `p2b`, `p3`, `p4a`, `p4b`, `p4c`, `p5a`, `p5b`, `p6`, `p7`, `p8`, `p9`, `p10`, `p11`, `p12`, `p13a`, `p13b`, `p13c`, `p14`, `p34`, `p35`, `p36`, `p15`,  `p16`, `p17`, `p18`, `p19`, `p20`, `p21`, `p22`, `p23`, `p24`, `p27`, `p28`, `p37`, `p38`, `p39`, `p40`, `p41`, `krok`, `typ`,
- `####_databaze_GPS.csv`: sloupce `p1`, `a`, `b`, `c`, `d`, `e`, `f`, `g`, `h`, `i`, `j`, `k`, `l`, `m`, `n`, `o`, `p`, `q`, `r`, `s`, `t`,
- `####_databaze_nasledky.csv`: sloupce `p1`, `id_vozidla`, `p59a`, `p59b`, `p59c`, `p59d`, `p59e`, `p59f`, `p59g`, `p59h`,
- `####_databaze_vozidla.csv`: sloupce `p1`, `id_vozidla`, `p44`, `p45a`, `p45b`, `p47`, `p48a`, `p48b`, `p49`, `p50a`, `p50b`, `p51`, `p52`, `p53`, `rok`, `pohlavi`, `p55a`, `p55b`, `p56`, `p57`, `p58` a
- `####_databaze_chodci.csv`: sloupce `p1`, `p29`, `p30`, `p31`, `p32`, `p33c`, `p33d`, `p33e`, `p33f`, `p33g`, `p33h`,

kde sloupec `p1` představuje klíčový sloupec, který jednoznačně identifikuje dopravní nehodu.

Data o\ nehodách v\ tomto formátu překopírujte do adresáře `DIRORIGIN/rawdata/accidents`.





# Konfigurace systému {#kap:konfigurace}

Způsob hledání  míst s\ vysokou nehodovostí je možné relativně flexibilně nastavit pomocí konfiguračních souborů. Všechny konfigurační soubory musí být uloženy v\ adresáři `DIRORIGIN/config`.

Konfigurace systému je rozdělena do dvou vrstev. Základní konfigurace je obsažena v\ souboru `DIRORIGIN/config/config.R`, který musí být v\ konfiguračním adresáři vždy obsažen a musí obsahovat všechny povinné proměnné. Tento soubor definuje všechny informace, jak se mají data zpracovávat.
Pokud je v\ adresáři `DIRORIGIN/config` uložen pouze tento konfigurační soubor, pak se pro každý okres a zvolený čas najde pouze jeden typ nebezpečných úseků.

Často je ale užitečné najít nebezpečné úseky z\ pohledu více kritérií. Typický příklad je situace, kdy chceme najít 1)\ úseky, kde dochází k\ velkému množství nehod bez ohledu na jejich závažnost, ale současně 2)\ i\ úseky, kde dochází zejména k\ závažným dopravním nehodám. K\ tomu slouží *profily* uložené do souborů `profile_XXX.R`, kde `XXX` je část jména souboru dodaná uživatelem.

Profily umožňují vytvořit několik různých konfigurací systému: např.\ jednu, která při výpočtu nehodových úseků nerozlišuje nehody podle jejich závažnosti, a druhou, která váží závažnost nehod podle zvolených kritérií. Stačí, aby jednotlivé profily definovaly jen ty proměnné, kterými se liší; hodnoty ostatních proměnných zdědí z\ nastavení `config.R`. (Zároveň však platí, že některé technické parametry mohou být definované pouze v\ `config.R`, a\ jsou tedy všem profilům společné.)

Všechny konfigurační soubory jsou technicky R\ skripty, a\ musí tedy dodržet platná syntaktická pravidla jazyka\ R. V\ nejjednodušším případě stačí modifikovat hodnoty proměnných, které skript definuje. Je ovšem také možné používat platné výrazy a dokonce vytvářet vlastní proměnné. Tyto proměnné je však nutné na konci skriptu smazat (mohou tedy sloužit pouze pro zpřehlednění konfigurace).

Ve všech konfiguračních skriptech platí následující pravidla:

- Každý konfigurační skript může obsahovat pouze povolené proměnné; některé proměnné musí obsahovat vždy.
- Tyto proměnné musejí mít přiřazenou platnou hodnotu.
- Vše od znaku křížek (`#`) do konce řádku je komentář.
- Hodnota se do proměnné přiřazuje pomocí znaku "rovná se" (`=`) tak, že jméno proměnné je vlevo a hodnota vpravo od znaku `=`.
- Hodnoty proměnných mohou být
    - čísla
        - čísla nesmějí obshovat mezery
        - desetinná místa se oddělují desetinnou tečkou (`.`)
        - velké hodnoty je možné zapsat "vědeckou notací", tj.\ 1\ 000 je možné zapsat jako `1e3`
    - řetězce uzavřené do uvozovek (např.\ `"motorway"`)
    - logické hodnoty (`TRUE` pro pravdu/ano a `FALSE` pro nepravdu/ne)
    - vektory čísel nebo řetězců
        - vektor se vytváří pomocí funkce `c()`
        - jeho jednotlivé hodnoty jsou odděleny čárkami (`,`)
    - tabulky

Seznam nezbytných a povolených proměnných se liší pro `config.R` a jednotlivé profily. Seznam těchto proměnných, jejich význam a povolené datové typy jsou stejně jako příklady zadávání jednotlivých typů hodnot uvedeny níže.


## Základní konfigurace (soubor config.R)

V\ tomto oddíle popíšeme všechny proměnné, které musejí být obsaženy v\ základním konfiguračním skriptu `config.R`. Pro přehlednost je rozdělíme do několika kategorií. (Stejným způsobem jsou tyto proměnné rozděleny i\ v\ souboru `config.R`.)


### Časová okna

Nejdříve je třeba nastavit, pro jaká období se mají nehodové úseky spočítat. To je možné udělat dvěma způsoby: buď období generovat automaticky, nebo je zadat ručně. Oba způsoby je možné kombinovat.

V\ případě automatických období uživatel specifikuje jejich délku v\ letech a jejich počet. Řekněme, že délka okna je tři roky, počet oken je dva a nehodové lokality se počítají 31.\ dubna 2023. V\ takovém případě se nehodové lokality spočítají pro roky 2020--2022 (1.\ okno) a 2017--2018 (2.\ okno). Obecně platí, že první časové okno se stanoví tak, aby mělo danou délku v\ letech a končilo 31.\ prosince posledního ukončeného roku. Druhé okno se stanoví tak, aby mělo danou délku a těsně předcházelo 1.\ oknu atd.

Pokud chce uživatel použít automatická okna, musí nastavit tři proměnné:

- `TIME_WINDOW_AUTO` ... logická hodnota, při využití automatických oken `TRUE`,
- `TIME_WINDOW_LENGHT` ... číselný vektor, délka časového okna v\ letech a
- `TIME_WINDOW_NUMBER` ... číselný vektor, počet časových oken, musí mít délku\ 1 nebo stejnou jako `TIME_WINDOW_LENGHT`.

Ukažme si několik příkladů:

Pokud chce uživatel nastavit automatická okna způsobem popsaným výše (délka 3\ roky, počet oken\ 2), stačí v\ konfiguraci nastavit:

```{r, eval=FALSE}
TIME_WINDOW_AUTO = TRUE
TIME_WINDOW_LENGHT = 3
TIME_WINDOW_NUMBER = 2
```

Pokud chce uživatel spočítat nehodové úseky na datech o\ délce 1\ rok a současně jiné úseky na datech o\ délce 3\ roky, může nastavit:

```{r, eval=FALSE}
TIME_WINDOW_AUTO = TRUE
TIME_WINDOW_LENGHT = c(1, 3)
TIME_WINDOW_NUMBER = 2
```

Pokud by navíc chtěl spočítat dvě časová okna délky 3\ roky a tři časová okna délky 1\ rok, nastaví:

```{r, eval=FALSE}
TIME_WINDOW_AUTO = TRUE
TIME_WINDOW_LENGHT = c(1, 3)
TIME_WINDOW_NUMBER = c(3, 2)
```

Ve většině situací bude uživateli stačit používat automatická časová okna, která umožní aktualizovat data bez toho, aby bylo potřeba měnit konfiguraci systému a přepočítávat údaje, které se v\ čase nemění (viz oddíl\ XXX).

V\ některých případech však může uživatel potřebovat najít nehodové lokality v\ pevně zadaných letech. K\ tomu slouží pevná časová okna zadaná pomocí parametru `TIME_WINDOW`. Do tohot parametru je třeba uložit tabulku se dvěma sloupci, `from_date` (počáteční datum časového okna) a `to_date` (koncové datum okna). Řádky tabulky pak odpovídají jednotivým časovým oknům. Datum se zadává jako řetězec ve formátu `"YYYY-MM-DD"`.

Dvě pevná časová okna o\ délce tří let je pak možné nastavit např.\ takto:

```{r, eval=FALSE}
TIME_WINDOW = tibble::tribble(
    ~from_date,    ~to_date,
    "2019-01-01",  "2021-12-31",
    "2018-01-01",  "2020-12-31"
)
```

Automatická a pevná časová okna je možné libovolně kombinovat. V\ případě, že budou použita pouze pevná časová okna, je třeba nastavit parametr `TIME_WINDOW_AUTO` na hodnotu `FALSE`.

V\ každém případě platí, že uživatel musí zajistit, aby měl systém přístup k\ datům o\ nehodách za dané roky.


### Váhy nehod
Jednotlivé nehody se liší svou závažností. Při hledání nebezpečných míst je proto užitečné vážit jednotlivé nehody podle jejich závažnosti. Hodnota nehody je rovna 

$$\textrm{cost} = d \times D + s \times S + l \times L + m \times M + c,$$

kde $D$\ je počet lidí, kteří při nehodě zahynuli, $S$\ je počet vážně zraněných, $L$\ je počet lehce zraněných a $M$\ je hodnota materiální škody v\ milionech\ Kč. Uživatel může zadat konstanty $d$, $s$, $l$, $m$ a $c$, které $d$, $s$ a $l$ určují, jaká váha se přikládá smrtelnému, těžkému a lehkému zranění respektive a jaká materiálním škodám. Jedno možné nastavení je nastavit $d$ na hodnotu statistického života v\ milionech\ Kč, $s$ a $l$ na její poměrné zlomky, $m=1$ a $c=0$.

Tyto koeficienty je možné nastavit pomocí proměnných 

- `UNIT_COST_DEAD` ... nezáporné číslo, váha smrtelného zranění ($d$),
- `UNIT_COST_SERIOUS_INJURY` ... nezáporné číslo, váha těžkého zranění ($s$),
- `UNIT_COST_LIGHT_INJURY` ... nezáporné číslo, váha lehkého zranění ($l$),
- `UNIT_COST_MATERIAL` ... nezáporné číslo, váha materiální škody v\ milionech\ Kč ($m$) a
- `UNIT_COST_CONST` ... nezáporné číslo, konstanta připočítaná k\ hodnotě každé nehody ($c$).

Příklad nastavení, kde se hodnota smrtelného zranění nastaví na hodnotu statistického života 16\ milionů\ Kč:

```{r, eval=FALSE}
UNIT_COST_DEAD = 16
UNIT_COST_SERIOUS_INJURY = UNIT_COST_DEAD / 4
UNIT_COST_LIGHT_INJURY = UNIT_COST_DEAD / 16
UNIT_COST_MATERIAL = 1
UNIT_COST_CONST = 0

```

Hodnota nehod se při výpočtu rizikových oblastí používá pouze v\ případě, kdy je proměnná `NKDE_WEIGHTS` nastavena na hodnotu `"cost"`, viz dále. Je však dobré nastavit tyto parametry vždy. I\ když chceme najít nehodové klastry, které váží všechny nehody stejně, nastavení těchto parametrů pak umožní říct, které klastry jsou spojeny s\ větší škodou.

**Alberiny Ščasný**

**Když moc vysoká hodnota stat. života, ostatní se ignoruje. Ale nehody náhodné. Možná nastavit níže.**


### Nastavení paralelních výpočtů
Většina přípravy dat probíhá paralelně na větším počtu jader. V\ této sekci se nastavuje, kolik jader může být využito. Jsou zde dvě možnosti: Buď uživatel nastaví počet jader sám, nebo dovolí systému, aby počet jader sám odhadl. V\ prvním případě uživatel nastaví proměnné `NO_OF_WORKERS` a `NO_OF_WORKERS_ACCIDENTS` na počet jader, který se má použít, ve druhém nechá obě proměnné nastavené na `"auto"` a zároveň nastaví proměnné `RAM_PER_CORE_GENERAL` a `RAM_PER_CORE_ACCIDENTS` na počet GB paměti RAM, který musí být dostupný na výpočet na jedno jádro. V\ současné době jsou tyto proměnné nastavené na konzervativní úrovni 3 a 10\ GB respektive. Při zvětšení objemu zpracovávaných dat však může být nezbytné tyto proměnné zvětšit.


### Příprava mapových podkladů
U\ vlastních mapových podkladů je třeba nastavit čtyři parametry.

1. Všechny výpočty probíhají po jednotlivých okresech. Aby nedocházelo ke zkreslením na hranicích okresu, je po dobu výpočtu třeba zahrnout i\ silnice nehody, které leží nedaleko za hranicí okresu (na konci výpočtu budou údaje ležící za hranicí okresu opět odříznuty). Proměnná `DISTRICT_BUFFER_SIZE` určuje o\ kolik metrů se má pro potřeby výpočtu posunout hranice okresu. Hodnota této proměnné musí být dostatečně větší než hodnota proměnných `NKDE_BW` (a `NKDE_TRIM_BW`, pokud je  hodnota `NKDE_ADAPTIVE` nastavena na `TRUE`).

2. Pro účely výpočtů se silniční síť rozdělí do krátkých, relativně homogenních úseků (lixelů). Tyto lixely musejí být tak krátké, aby byly v\ rámci silniční sítě velmi podobně dlouhé; zároveň však platí, že čím jsou kratší, tím je jich více a výpočet běží pomaleji a vyžaduje vyšší zdroje. Současné nastavení je proto při současném stavu zdrojů a kvalitě mapových podkladů zřejmě optimální. Uživatel je však může změnit pomocí dvou proměnných: Proměnná `LIXEL_SIZE` nastavuje typickou délku lixelu v\ metrech (doporučené nastavení je 5\ metrů). Proměnná `LIXEL_MIN_DIST` určuje minimální délku lixelu v\ metrech; kratší lixely budou připojeny k\ sousednímu lixelu.

3. OpenStreetMaps obsahují cesty mnoha typů, z\ nichž mnohé nejsou určeny pro motorová vozidla. Při práci s\ mapovými podklady se tyto typy cest ignorují. Proměnná `SUPPORTED_ROAD_CLASSES` obsahuje výčet všech typů cest, které se mají použít. V\ současné době je ve skriptu výčet všech typů cest, které OpenStreetMaps nyní používají, s\ tím, že nevhodné typy jsou odstraněny pomocí komentářů.

4. Některé nehody mohou být zaměřeny velmi nepřesně\ -- daleko od silniční sítě. V\ takovém případě se při výpočtu rizikových míst ignorují. Proměnná `ACCIDENT_TO_ROAD_MAX_DISTANCE` určuje maximální vzdálenost od silniční sítě v\ metrech, při které jsou nehody použitý při hledání rizikových oblastí.


### Parametry výpočtu hustot

`NKDE_WEIGHTS` <- "cost" "equal"

NKDE bandwidth in meters\
`NKDE_BW` <- 300

whether adaptive bandwidth is used---either TRUE or FALSE; TRUE may produce
slightly more precise results but the computation would be much slower\
`NKDE_ADAPTIVE` <- FALSE

maximum bandwidth tried when NKDE_ADAPTIVE is TRUE---in meters\
`NKDE_TRIM_BW` <- 600

NKDE method---either "continuous" or "discontinuous"; "discontinuous" is less
precise but much faster\
`NKDE_METHOD` <- "discontinuous"

to which distance in meters are the accidents aggregated---for a faster
computation\
`NKDE_AGG` <- 1


#### Parametry pro hledání klastrů
Mechanismus hledání klastrů je poměrně jednoduchý. Nejdříve se najdou všechny souvislé lixely s\ hustotou pravděpodobnosti vyšší než zadaný práh\ $h$. Tak vzniknou prvotní klastry. Následně se tyto klastry rozšíří na všechny strany o\ $v$\ lixelů. V\ posledním kroku spojí ty klastry, které mají vzájemný průnik.

Práh\ $h$ je stanoven dynamicky jako určitý vysoký kvantil. Tento kvantil je určen proměnnou `CLUSTER_MIN_QUANTILE`, která musí nabývat hodnotu z\ intervalu $[0,1]$, typicky však velmi blízkou jedné. Počet dodatečných lixelů\ $v$ je určen proměnnou `CLUSTER_ADDITIONAL_STEPS` (minimální hodnota je\ 1).

Do interaktivní aplikace jsou exportovány i\ lixely, které mají vysokou hodnotu pravděpodobnosti nehody. Minimální kvantil lixelů, které jsou takto exportovány, určuje proměnná `VISUAL_MIN_QUANTILE`. Tato proměnná musí mít vždy menší hodnotu než `CLUSTER_MIN_QUANTILE`.



### Vybrané okresy
Pokud z\ nějakého důvodu hledat rizikové oblasti ve všech okresech, je možné vypočet spustit pouze pro vybrané okresy. Nepovinná proměnná `DISTRICTS` v\ takovém případě vyjmenuje CZ\ NUT3 vybraných okresů.

Pokud mají výpočty proběhnout pro všechny okresy, pak proměnná `DISTRICTS` nesmí být v\ konfiguračním souboru vytvořena.


## Profily


## Zpracovaná konfigurace a profily

Software pro přípravu dat nejdříve načte konfiguraci a všechny profily, zkontroluje je a uloží do souboru `profiles.rds`. Tento soubor proto vymažte pouze v\ případě, kdy je třeba zajistit kompletní přepočítání konfigurace a profilů, např.\ v\ případě, kdy byl některý profil smazán.





# Běh systému

Po svém spuštění systém provádí postupně následující kroky:

1. vytvoří nový log-file v\ adresáři `DIRORIGIN/log`
2. aktualizuje konfiguraci systému (soubor `DIRORIGIN/config/profiles.rds`)
3. aktualizuje tabulku okresů
4. aktualizuje mapové podklady silniční sítě
    - vyfiltruje dopravní komunikace, které mají být zahrnuty, v\ jednotlivých okresech
    - zjednoduší takto vzniklou silniční síť tak, že se pokusí sloučit extrémně krátké úseky sítě
    - rozdělí silnice do krátkých úseků (*lixely*; doporučená délka je 5\ m) a najde středy těchto úseků
5. aktualizuje data o\ dopravních nehodách
6. spočítá síťové hustoty pravděpodobnosti nehodové škody na jednotlivých *lixelech*
7. najde souvislé shluky lixelů, kde je pravděpodobnost výskytu nebo výše nehod extrémně vysoká

Kroky 4--7 jsou paralelizované tak, že výpočet pro každý okres nebo kombinaci okresu, času a profilu je spuštěna na separátním jádře.

Následující krok je spuštěn až ve chvíli, kdy doběhne celý předchozí krok. Pokud výpočet z\ jakéhokoli důvodu selže pro jeden okres, data pro ostatní okresy budou aktualizována. Na konci kroku se však běh zastaví. Informace o\ problémech jsou uložena v\ logu.

Pokud data vytvořená v\ daném kroku neexistují, jsou vytvořena. Pokud existují, jsou aktualizována pouze v\ případě, že čas poslední modifikace souboru je starší, než čas modifikace souborů, které jsou použity při jeho výpočtu. Aktualizace tedy respektují jednoduché závislosti způsobem podobným `make`.

Při prvním spuštění tedy proběhnou všechny kroky. Následně je třeba data připravovat vždy, když jsou aktualizována data o\ dopravních nehodách. V\ takovém případě proběhnou pouze kroky\ 1 a 5--7, takže příprava dat bude podstatně rychlejší než při prvním spuštění. Pokud uživatel aktualizuje data o\ tvaru okresů nebo data o\ silniční síti, bude aktualizován jak daný krok, tak všechny následující. Pokud uživatel změní konfigurační soubor nebo profily, budou aktualizována všechna data.





# Průběžně vytvářená data



# Výstupy systému



# Spuštění systému {#sec:aktutalizace-dat}



# Aktualizace dat

pro změně vstupních dat a konfigurace/profilů -- ala Makefile





# Interpretace klastrů {#sec:interpret}





# Výstup pro GIS

Složka `DIRORIGIN/data/output/gis` obsahuje identifikovaná nebezpečná místa exportovaná ve formátu pro GIS. Data jsou rozdělena po jednotlivých okresech tak, že nebezpečné úseky pro každý okres jsou umístěny do zvláštního podadresáře, jehož jméno je NUTS\ 4 kód daného okresu (Hlavní město Praha je chápána jako jeden celek). Kromě těchto adresářů obsahuje složka ještě soubory `profiles.csv` a `profiles.dbf`, které popisují profily, které byly použity při generování nebezpečných míst.

Příklad obsahu adresáře `DIRORIGIN/data/output/gis`:

- `profiles.csv`
- `profiles.dbf`
- `CZ0100`
    - `clusters_CZ0100_cost_2016-01-01_2018-12-31.shp` 
    - `clusters_CZ0100_cost_2019-01-01_2021-12-31.shp`
    - `clusters_CZ0100_cost_2020-01-01_2020-12-31.shp`
    - `clusters_CZ0100_cost_2021-01-01_2021-12-31.shp`
    - `clusters_CZ0100_equal_2016-01-01_2018-12-31.shp`
    - `clusters_CZ0100_equal_2019-01-01_2021-12-31.shp`
    - `clusters_CZ0100_equal_2020-01-01_2020-12-31.shp`
    - `clusters_CZ0100_equal_2021-01-01_2021-12-31.shp`
    - `clustered_accidents_CZ0100_cost_2016-01-01_2018-12-31.dbf`
    - `clustered_accidents_CZ0100_cost_2019-01-01_2021-12-31.dbf`
    - `clustered_accidents_CZ0100_cost_2020-01-01_2020-12-31.dbf`
    - `clustered_accidents_CZ0100_cost_2021-01-01_2021-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2016-01-01_2018-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2019-01-01_2021-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2020-01-01_2020-12-31.dbf`
    - `clustered_accidents_CZ0100_equal_2021-01-01_2021-12-31.dbf`
- `CZ...`

(Ke každému souboru typu `.shp` jsou přiloženy i\ odpovídající soubory typů `.dbf`, `.prj` a `.shx`.)



## Shapefily nebezpečných míst

Adresář pro každý okres obsahuje všechny typy nebezpečných míst spočítaných v\ průběhu přípravy dat pro webovou aplikaci. Jednotlivé shapefily mají vždy jméno `clusters_NUTS4_PROFILENAME_YYYY-MM-DD_YYYY-MM-DD`, kde `NUTS4` je kódové jméno okresu, `PROFILENAME` je jméno profilu a `YYYY-MM-DD` označuje den počátku a konce období, pro které byly nebezpečné úseky identifikovány.

Atributová tabulka těchto shapefilů obsahuje následující proměnné:

- `dst_id` ... NUTS\ 4 kód daného okresu,
- `dst_name` ... jméno daného okresu,
- `start` ... datum počátku období, pro které byly nehodové úseky počítány,
- `end` ... datum konce období, pro které byly nehodové úseky počítány,
- `profile` ... jméno profilu, který byl použit,
- `severity` ... kolik promile nejnebezpečnějších úseků tvoří klastr,
- `add_lix` ... o\ kolik *lixelů* byly klastry do všech stran rozšířeny,
- `cluster` ... identifikační číslo daného klastru pro dané hodnoty `dst_id`, `dst_name`, `start`, `end`, `profile`, `severity` a `add_lix`,
- `length` ... délka identifikovaného klastru v\ metrech,
- `density` ... součet hustoty idenfikovaného klastru a
- `cost` ... celkové náklady všech nehod v\ klastru v\ milionech Kč.

Každý shapefile obsahuje nehodové úseky spočítané pro daný okres, profil a časové okno a mnoho různých nastavení hodnot `severity` a `add_lixel`. To má několik důsledků:

1. Při analytické práci je třeba v\ GISu vyfiltrovat zvolené hodnoty `severity` a `add_lixel`.
2. Identifikace klastru pomocí jeho čísla `cluster` není jednoznačná. Úplný klíč k\ identifikaci klastru tvoří kombinace sloupců `dst_id`, `start`, `end`, `profile`, `severity`, `add_lix` a `cluster`.
    - Stejné číslo klastru může existovat pro různé kombinace hodnot `dst_id`, `dst_name`, `start`, `end`, `profile`, `severity` a `add_lix`.
    - Mezi těmito klastry neexistuje žádný vztah.

Návod, jak interpretovat jednotlivé nehodové klastry, viz oddíl\ \ref{sec:interpret}.



## Údaje o\ nehodách na klastrech

Ke každému shapefilu se jménem `clusters_NUTS4_PROFILENAME_YYYY-MM-DD_YYYY-MM-DD` existuje tabulka `clustered_accidents_NUTS4_PROFILENAME_YYYY-MM-DD_YYYY-MM-DD`, která uvádí informace o\ nehodách, které "tvoří" daný klastr. Z\ těchto nehod je spočítaná i\ celková nebezpečnost klastru `cost`.

Atributová tabulka zde obsahuje jen nejnutnější údaje:

- `dst_id` ... NUTS4 kód daného okresu,
- `dst_name` ... jméno daného okresu,
- `start` ... datum počátku období, pro které byly nehodové úseky počítány,
- `end` ... datum konce období, pro které byly nehodové úseky počítány,
- `profile` ... jméno profilu, který byl použit,
- `severity` ... kolik promile nejnebezpečnějších úseků tvoří klastr (hodnota\ 5 znamená, že se klastry skládají z\ 5\ promile nejhorších úseků),
- `add_lix` ... o\ kolik *lixelů* se klastry zvětší,
- `acc_id` ...
- `cluster` ... identifikační číslo daného klastru a
- `cost` ... celkové náklady všech nehod v\ klastru v\ milionech Kč.

Sloupce `dst_id`, `start`, `end`, `profile`, `severity`,  `add_lix` a `cluster` tvoří klíč ke spárování nehody s\ klastry v\ shapefilech. Sloupec `acc_id` tvoří klíč pro spárování nehody v\ policejní databázi. Proměnná `cost` obsahuje cenu nehody v\ milionech Kč spočítanou podle daného profilu.

Předpokládá se, že při potřebě analyzovat jednotlivé nehody, budou tyto nehody načteny z\ policejní databáze a spárovány pomocí klíče `acc_id`.



## Informace o\ nastavení profilů

Informace o\ nastavení použitých profilů jsou uloženy v\ adresáři `DIRORIGIN/data/output/gis` v\ souborech `profiles.dbf` a `profiles.csv`. Oba soubory mají shodnou strukturu. Jedná se o\ tabulku, jejíž jednotlivé řádky odpovídají jednotlivým profilům a použitým časovým oknům. Každý profil je identifikován třemi sloupci:

- `PROFILE_NAME` ... jméno profilu,
- `FROM_DATE` ... počáteční datum období, pro které byly nebezpečné úseky identifikovány, a
- `TO_DATE` ... koncové datum období, pro které byly nebezpečné úseky identifikovány.

Ostatní sloupce  odpovídají jednotlivým parametrům zadaným v\ konfiguračních profilech. 

To znamená, že např.\ shapefilu `clusters_CZ0100_equal_2019-01-01_2021-12-31` odpovídá profil, který má ve sloupci `PROFILE_NAME` hodnotu "equal" a ve sloupcích `FROM_DATE` a `TO_DATE` hodnoty "2019-01-01" a "2021-12-31" respektive.

Tam, kde může daný parametr obsahovat vektor, jsou jednotlivé hodnoty tohoto vektoru převedeny na řetězec a spojeny do jednoho řetězce; jsou odděleny znaky "\  |\ " (mezera, trubka a mezera).

Soubory `profiles.csv` a `profiles.dbf` mají shodný obsah, liší se pouze formátem. Doporučujeme použít soubor ve formátu CSV, protože ve druhém souboru jsou jména sloupců strojově zkrácena. Výhodou souboru ve formátu DBF je to, že je možné jej přímo načíst do GISu.
